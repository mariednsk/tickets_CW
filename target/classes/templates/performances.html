<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Афиша — Справочная система театра</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <style>
        body { background:#f5f0eb; font-family: "Arial", sans-serif; color:#321b0c; margin:0; }
        .topbar { position: sticky; top:0; z-index:50; }
        .container { max-width:1100px; margin:100px auto 60px; padding:0 16px; }
        h1 { text-align:center; color:#321b0c; margin-bottom:18px; font-size:34px; }
        .filters { display:flex; gap:12px; justify-content:center; margin-bottom:18px; align-items:center; }
        .filter-select, .filter-input { padding:8px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.12); }
        .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:18px; align-items:start; }
        .card { background:white; border-radius:10px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.08); transition: transform .18s ease, box-shadow .18s ease; }
        .card:hover { transform: translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,0.14); }
        .thumb {
            width: 100%;
            height: 260px;
            object-fit: cover;
            display: block;
        }


        .card-content { padding:14px; }
        .card-title { font-weight:700; margin:0 0 6px; font-size:18px; color:#321b0c; }
        .card-meta { font-size:13px; color:#6b5b50; margin-bottom:8px; }
        .card-actions { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:8px; }
        .btn { background:#321b0c; color:white; padding:8px 12px; border-radius:6px; text-decoration:none; }
        .btn.secondary { background: transparent; color:#321b0c; border:1px solid #d6c8bd; }
        .pagination { display:flex; gap:8px; justify-content:center; margin-top:18px; }
        .page-btn { padding:6px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); background:white; cursor:pointer; }
        .page-btn.active { background:#321b0c; color:white; }

        /* адаптив */
        @media (max-width:600px){ .thumb {height:140px} }
    </style>
</head>
<body>

<!-- Шапка: главная, вход/рег/мои билеты/выйти -->
<div class="w3-top topbar">
    <div class="w3-row w3-padding w3-black">
        <div class="w3-col s3"><a th:href="@{/}" class="w3-button w3-block w3-black">Главная</a></div>
        <div class="w3-col s3" sec:authorize="isAnonymous()">
            <a th:href="@{/login}">Вход</a>

        </div>
        <div class="w3-col s3" sec:authorize="isAnonymous()"><a th:href="@{/register}" class="w3-button w3-block w3-black">Регистрация</a></div>
        <div class="w3-col s3" sec:authorize="isAuthenticated()">
            <div style="display:flex;">
                <a th:href="@{/mytickets}" class="w3-button w3-block w3-black" style="flex:1">Мои билеты</a>
                <form th:action="@{/logout}" method="post" style="margin:0">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="w3-button w3-black" style="border-left:1px solid rgba(255,255,255,0.06)">Выйти</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <h1>Афиша спектаклей</h1>

    <div class="filters">
        <select id="genre" class="filter-select">
            <option value="">Все жанры</option>
            <option th:each="g : ${genres}" th:text="${g}" th:value="${g}"></option>
        </select>

        <input id="search" class="filter-input" placeholder="Поиск по названию...">
        <button id="btnClear" class="filter-input">Сбросить</button>
    </div>

    <div id="grid" class="grid">
        <!-- карточки подгружаются JS -->
    </div>

    <div class="pagination" id="pagination"></div>
</div>

<script>
    const grid = document.getElementById('grid');
    const pagination = document.getElementById('pagination');
    const genreSelect = document.getElementById('genre');
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('btnClear');

    let page = 0, size = 3, totalPages = 0;

    async function load() {
        const genre = encodeURIComponent(genreSelect.value || "");
        const search = encodeURIComponent(searchInput.value || "");

        const resp = await fetch(`/api/performances?page=${page}&size=${size}&genre=${genre}&search=${search}`);
        if (!resp.ok) {
            grid.innerHTML = "<p>Не удалось загрузить афишу.</p>";
            return;
        }

        const data = await resp.json();
        const items = data.content || [];
        totalPages = data.totalPages || 0;

        grid.innerHTML = items.map(p => `
        <div class="card">
            <a href="/performances/${p.id}">
                <img class="thumb" src="/images/${p.image}">
            </a>
            <div class="card-content">
                <div class="card-title">${escapeHtml(p.title)}</div>
                <div class="card-meta">${p.genre} · ${p.date} ${p.time}</div>
                <a class="btn" href="/performances/${p.id}">Подробнее</a>
            </div>
        </div>
    `).join('');

        renderPagination();
    }


    function renderPagination(){
        pagination.innerHTML = '';
        for(let i=0;i<totalPages;i++){
            const b = document.createElement('button');
            b.className = 'page-btn' + (i===page ? ' active' : '');
            b.textContent = i+1;
            b.onclick = ()=> { page = i; load(); };
            pagination.appendChild(b);
        }
    }

    function buyPlaceholder(e, id){
        // если не авторизован — Spring Security перенаправит на /login
        // пока просто показываем заглушку и предотвращаем переход
        e.preventDefault();
        alert('Функция выбора мест появится позже. Пока — заглушка.');
        return false;
    }

    function escapeHtml(s){ if (!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // фильтры
    genreSelect.addEventListener('change', () => { page = 0; load(); });
    searchInput.addEventListener('input', () => {
        page = 0;
        load();
    });
    clearBtn.addEventListener('click', ()=> { genreSelect.value=''; searchInput.value=''; page=0; load(); });

    // initial
    load();
</script>
</body>
</html>
