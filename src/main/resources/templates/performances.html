<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ê—Ñ–∏—à–∞ ‚Äî –°–ø—Ä–∞–≤–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–∞—Ç—Ä–∞</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <style>
        body { background:#f5f0eb; font-family: "Arial", sans-serif; color:#321b0c; margin:0; }
        .topbar { position: sticky; top:0; z-index:50; }
        .container { max-width:1100px; margin:100px auto 60px; padding:0 16px; }
        h1 { text-align:center; color:#321b0c; margin-bottom:18px; font-size:34px; }
        .filters { display:flex; gap:12px; justify-content:center; margin-bottom:18px; align-items:center; }
        .filter-select, .filter-input { padding:8px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.12); }
        .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:18px; align-items:start; }
        .card { background:white; border-radius:10px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.08); transition: transform .18s ease, box-shadow .18s ease; }
        .card:hover { transform: translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,0.14); }
        .thumb {
            width: 100%;
            height: 260px;
            object-fit: cover;
            display: block;
        }
        .card-content { padding:14px; }
        .card-title { font-weight:700; margin:0 0 6px; font-size:18px; color:#321b0c; }
        .card-meta { font-size:13px; color:#6b5b50; margin-bottom:8px; }
        .card-actions { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:8px; }
        .btn { background:#321b0c; color:white; padding:8px 12px; border-radius:6px; text-decoration:none; }
        .btn.secondary { background: transparent; color:#321b0c; border:1px solid #d6c8bd; }
        .pagination { display:flex; gap:8px; justify-content:center; margin-top:18px; }
        .page-btn { padding:6px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); background:white; cursor:pointer; }
        .page-btn.active { background:#321b0c; color:white; }
        /* –∞–¥–∞–ø—Ç–∏–≤ */
        @media (max-width:600px){ .thumb {height:140px} }
    </style>
</head>
<body>
<!-- –®–∞–ø–∫–∞: –≥–ª–∞–≤–Ω–∞—è, –≤—Ö–æ–¥/—Ä–µ–≥/–º–æ–∏ –±–∏–ª–µ—Ç—ã/–≤—ã–π—Ç–∏ -->
<div class="w3-top topbar">
    <div class="w3-row w3-padding w3-black">
        <div class="w3-col s3"><a th:href="@{/}" class="w3-button w3-block w3-black">–ì–ª–∞–≤–Ω–∞—è</a></div>
        <div class="w3-col s3"><a th:href="@{/actors}" class="w3-button w3-block w3-black">–ê—Ä—Ç–∏—Å—Ç—ã</a></div>
        <div class="w3-col s2 m2 l2">
            <a th:href="@{/about}" class="w3-button w3-block w3-black">–û–± –∞–≤—Ç–æ—Ä–µ</a>
        </div>
        <div class="w3-col s3" sec:authorize="isAuthenticated()">
            <a th:href="@{/profile}" class="w3-button w3-block w3-black">
                üë§ <span sec:authentication="name"></span>
            </a>
        </div>
        <div class="w3-col s3" sec:authorize="isAnonymous()">
            <a th:href="@{/login}">–í—Ö–æ–¥</a>
        </div>
        <div class="w3-col s3" sec:authorize="isAnonymous()"><a th:href="@{/register}" class="w3-button w3-block w3-black">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
        <div class="w3-col s3" sec:authorize="isAuthenticated()">
            <div style="display:flex;">
                <form th:action="@{/logout}" method="post" style="margin:0">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button class="w3-button w3-black" style="border-left:1px solid rgba(255,255,255,0.06)">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="container">
    <h1>–ê—Ñ–∏—à–∞ —Å–ø–µ–∫—Ç–∞–∫–ª–µ–π</h1>
    <div class="filters">
        <select id="genre" class="filter-select">
            <option value="">–í—Å–µ –∂–∞–Ω—Ä—ã</option>
            <option th:each="g : ${genres}" th:text="${g}" th:value="${g}"></option>
        </select>
        <input id="actor" class="filter-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏—Å—Ç—É...">
        <input id="search" class="filter-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        <button id="btnClear" class="filter-input">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
    <div id="grid" class="grid">
        <!-- –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è JS -->
    </div>
    <div class="pagination" id="pagination"></div>
</div>
<script>
    function readStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        page = parseInt(params.get('page') || '0', 10) || 0;
        genreSelect.value = params.get('genre') || '';
        searchInput.value = params.get('search') || '';

    }

    function writeStateToUrl() {
        const params = new URLSearchParams();
        params.set('page', String(page));
        if (genreSelect.value) params.set('genre', genreSelect.value);
        if (searchInput.value) params.set('search', searchInput.value);
        history.replaceState(null, '', `/performances?${params.toString()}`);
    }


    const grid = document.getElementById('grid');
    const pagination = document.getElementById('pagination');
    const genreSelect = document.getElementById('genre');
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('btnClear');
    const actorInput = document.getElementById('actor');

    let page = 0, size = 3, totalPages = 0;

    async function load() {
        const actor = actorInput.value || '';
        const genre = genreSelect.value || '';
        const search = searchInput.value || '';
        const resp = await fetch(`/api/performances?page=${page}&size=${size}&genre=${encodeURIComponent(genre)}&search=${encodeURIComponent(search)}&actor=${encodeURIComponent(actor)}`);
        if (!resp.ok) {
            grid.innerHTML = "<p style='text-align:center;color:red;'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ñ–∏—à—É.</p>";
            pagination.innerHTML = '';
            return;
        }
        const data = await resp.json();
        const items = data.content || [];
        totalPages = data.totalPages || 0;

        if (totalPages === 0) {
            page = 0;
            writeStateToUrl();
        }

        if (totalPages > 0 && page >= totalPages) {
            page = totalPages - 1;
            writeStateToUrl();
            return load(); // üî• –∑–∞–Ω–æ–≤–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        }

        const detailsUrl = (id) =>
            `/performances/${id}?page=${page}&genre=${encodeURIComponent(genre)}&search=${encodeURIComponent(search)}`;

        grid.innerHTML = items.map(p => `
<div class="card">
    <a href="${detailsUrl(p.id)}">
      <img class="thumb" src="/uploads/${p.image}" alt="${p.title}">
    </a>
    <div class="card-content">
      <div class="card-title">${p.title}</div>
      <div class="card-meta">${p.genre} ¬∑ ${p.date} –≤ ${p.time}</div>

      <!-- –ù–û–í–û–ï: –ê—Ä—Ç–∏—Å—Ç—ã -->
      <div class="card-artists" style="margin-top:12px; font-size:14px; color:#6b5b50;">
        <strong>–ê—Ä—Ç–∏—Å—Ç—ã:</strong>
        ${p.actors && p.actors.length > 0
            ? p.actors.map(a => `<a href="/actors/${a.id}" style="color:#321b0c; text-decoration:none; font-weight:600;">${a.fullName}</a>`).join(', ')
            : '<span style="color:#999;">–Ω–µ —É–∫–∞–∑–∞–Ω—ã</span>'
        }
      </div>
    </div>
    <div class="card-actions">
      <a class="btn" href="${detailsUrl(p.id)}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
      <button type="button" class="favorite-btn" data-id="${p.id}">
        <span class="heart">‚ô°</span>
      </button>
    </div>
  </div>
`).join('');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–¥–µ—á–∫–∏
        document.querySelectorAll('.favorite-btn').forEach(btn => {
            const id = btn.dataset.id;

            // –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
            fetch(`/api/performances/${id}/favorite`)
                .then(r => r.json())
                .then(isFav => {
                    btn.querySelector('.heart').textContent = isFav ? '‚ù§Ô∏è' : '‚ô°';
                })
                .catch(() => {});

            // –ö–ª–∏–∫ ‚Äî —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è
            btn.addEventListener('click', async (e) => {
                e.preventDefault(); // –Ω–∞ –≤—Å—è–∫–∏–π

                const authResp = await fetch('/api/user/authenticated');
                const isAuth = await authResp.json();

                if (!isAuth) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!');
                    return;
                }

                const heart = btn.querySelector('.heart');
                const method = heart.textContent === '‚ô°' ? 'POST' : 'DELETE';

                await fetch(`/api/performances/${id}/favorite`, { method: method });

                heart.textContent = method === 'POST' ? '‚ù§Ô∏è' : '‚ô°';
            });
        });

        renderPagination();
    }

    function renderPagination() {
        pagination.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 0; i < totalPages; i++) {
            const b = document.createElement('button');
            b.className = 'page-btn' + (i === page ? ' active' : '');
            b.textContent = i + 1;
            b.onclick = () => {
                page = i;
                writeStateToUrl();
                load();
            };
            pagination.appendChild(b);
        }
    }

    // –§–∏–ª—å—Ç—Ä—ã
    genreSelect.addEventListener('change', () => {
        page = 0;
        writeStateToUrl();   // ‚úÖ
        load();
    });

    searchInput.addEventListener('input', () => {
        page = 0;
        writeStateToUrl();   // ‚úÖ
        load();
    });

    clearBtn.addEventListener('click', () => {
        genreSelect.value = '';
        searchInput.value = '';
        page = 0;
        writeStateToUrl();   // ‚úÖ
        load();
    });

    actorInput.addEventListener('input', () => { page = 0; writeStateToUrl(); load(); });



    readStateFromUrl();
    writeStateToUrl();
    load();

    window.addEventListener('pageshow', () => {
        readStateFromUrl();
        load();
    });

</script>
</body>
</html>